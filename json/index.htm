<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="renderer" content="webkit" /> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta content="telephone=no" name="format-detection">
	<meta content="email=no" name="format-detection">
    <meta name="description" content="Xfunction 拟提供互联网工具服务，特别提供短地址服务">
	<meta name="keywords" content="缩短网址,网址压缩,网址缩短,短网址,短域名,短地址,短URL,免费缩短网址,短链接生成器,短网址生成,免费缩址,域名伪装,域名转向,网站推广,短链接,长网址变短网址">
	<meta name="author" content="kelvin Dong">
    <title>XFunction</title>
    <style type="text/css">
        *{margin: 0;padding: 0;}
        body{ font:14px Helvetica,Tahoma,Arial,"\5FAE\8F6F\96C5\9ED1",sans-serif;color:#222;}
        .wrapper{text-align: center;height: 100%;position: fixed;min-height: 500px;width: 100%;}
        .wrapper img {margin-top:15%;margin-bottom:-27px}
        .input{margin-top: 30px;}
        .error{margin-top: 2px;color:red;}
        .input input{width: 200px;height: 37px;}
        .input button{width: 80px;height: 37px;}        
        
        .footer{position: absolute;bottom: 0px; width: 100%;background:#1976d2;color:white}        
        .result{margin-top: 20px;}        
        .copyClip{width: 60px;height: 27px;}
        
        .title{}
        .master{font-size:3em;font-weight:bold;}
        
    </style>
<!-- script 引入文件放在前面，防止页面展示时显示angular的程序信息，把运行代码放在body后，这些运行很快的 -->
<script type="text/javascript" src="../js/jquery-2.2.1.min.js"></script>
<script type="text/javascript" src="../js/jquery.qrcode.min.js"></script>
<script type="text/javascript" src="../js/angular.min.js"></script>
<script type="text/javascript" src="../js/config.js"> </script>
<script type="text/javascript" src="../js/utils.js"> </script>
<script type="text/javascript" src="../js/layer/layer.js"> </script>
<script type="text/javascript" src="../js/clipboard.min.js"> </script>
</head>
<body ng-app="app" ng-controller="activityCtrl"  >
    <div class="wrapper">
		<div class="title">
			<a href="../" style="color: #000000; text-decoration:none;"><img src="../images/trans-black-full-logo.png" width="280px"> </a><span style="margin-left:5px;cursor:pointer" >JSON to CSV</span>
		</div>
        <div class="input">
            <input type="file" id="jsonFile" name="jsonFile" accept=".json" onchange="change()">            
            <button ng-click="get()" id="idGet" disabled >{{progress}}</button><br>
        </div>
        <div class="error" ng-show = "inputFlag">
            <span>{{errorMsg}}</span>
        </div>
        <div class="result" ng-show="resultFlag" >
            <span>下载结果： <a  href="{{resultUrl}}" target="_blank" >{{resultUrl}}</a> ，有效期1天 。</span>    
                        
        </div>
        <div class="help"  >
        	   <p>说明： </p>
               <p>1、输入JSON文件格式（JSON数组）
                             
               [
                 {"":"","":"","",""},
                 {"":"","":"","",""},
                 {"":"","":"","",""},
                 {"":"","":"","",""},
                 {"":"","":"","",""}
               ]
               
               </p>
               <p>2、输出CSV文件，首行属性名称以逗号分开，每行为一条数据。如果字符串中存在逗号，将强制转化为全角逗号。 
                             
               
               
               </p>
                        
        </div>
        <div class="footer">
        		<div>*仅供学习*</div>
                <span>©2019 学习笔记   xfunction.cn  xfu.biz</span>      
        </div>
    </div>
</body>

<script type="text/javascript">
var app = angular.module('app', []);
app.controller('activityCtrl', function($scope,$http,$window) {
	
	$scope.inputFlag=false;
	$scope.resultFlag=false;	
	$scope.jsonFile= null;		
	$scope.errorMsg="";
	$scope.progress="提交";
	$scope.resultUrl="#";
				
	$scope.get=function(){

		$scope.resultFlag=false;
		
		var upFile = $scope.jsonFile;
		
		$("#idGet").prop('disabled',true);
						
		var fd = new FormData();
		fd.append('jsonFile',$scope.jsonFile);
		
		//开始上传
		$.ajax({
			url: baseUrlCon.baseAPI+'json/parse',
		    type: 'POST',
		    dataType: "json",//预期服务器返回的数据类型
		    cache: false,
		    data: fd,
		    processData: false,
		    contentType: false,    //formData原始格式提供
		    xhr:function(){
		    	var myXhr = $.ajaxSettings.xhr();  
		    	if(myXhr.upload){ //检查upload属性是否存在  
		    		myXhr.upload.addEventListener('progress',$scope.progressHandlingJson, false);   
		    	}
		    	return myXhr; //xhr对象返回给jQuery使用  
		    },
		    success: function (result) {			    			    	
		    	if(result.success){
		    		$scope.progress="成功";  	
		    		$scope.resultFlag=true; 
		    		//alert(result.data);
		    		$scope.resultUrl=baseUrlCon.baseAPI+"JSON/"+result.data;
		    	}else{
		    		$scope.progress="失败";
		    		alert(result.msg);
		    	}
		    	$scope.$apply();//Angular的双向绑定在和第三方类库混用的时候有时会失效
		    },
		    error:function(XMLHttpRequest, textStatus, errorThrown){	
		    	if(isEmptyOrNull(XMLHttpRequest.responseJSON))
		    		alert("错误");
		    	else
		   			alert("错误提示:"+XMLHttpRequest.responseJSON.errorMsg +"-"+ XMLHttpRequest.responseJSON.msg);
		   	}
		});		
		
		
		/*
		var param ={bizLinkUrl: bizLinkUrl};		
		var ajaxPost = $.ajax({
			type: "post",
			url: baseUrlCon.baseAPI+'shortLink/set',
			timeout: 30000,// 超时设置
			contentType: 'application/json', 
		   	data:JSON.stringify(param),
		   	dataType: "json",
		    success: function(data) {
		    	
		    	if(data.success){
		    		$scope.bizLinkUrl=null;
		    		$scope.resultFlag=true;
		    		console.log(data.data)
		    		var temp="https://xfu.biz/"+data.data.bizLinkId64;
		    		$scope.resultBizLinkId64 = temp;
		    		$scope.resultBizLinkUrl=data.data.bizLinkUrl;
		    		$scope.resultBizLinkVisitSum = data.data.bizLinkVisitSum;
		    		$scope.statsUrl = "stats.htm?code="+data.data.bizLinkId64
		    		generateQrCode(temp)		    		
		    	}else{		    		
		    		$scope.errorMsg=data.msg;
					$scope.inputFlag=true;
		    	}   
		    	$("#idGet").prop('disabled',false);
		    	
		    	
		    	$scope.$apply();//Angular的双向绑定在和第三方类库混用的时候有时会失效
		    },
		    error:function(){	
		    	$("#idGet").prop('disabled',false);
		    	
		    	
		    	$scope.errorMsg="失败！请重试，并保证输入URL可以被正常访问！";
				$scope.inputFlag=true;
		    	$scope.$apply();//Angular的双向绑定在和第三方类库混用的时候有时会失效
		    },
		    complete : function(XMLHttpRequest,status){
		    	if(status=='timeout'){
		    		ajaxPost.abort();
		    		
		    		$("#idGet").prop('disabled',false);
			    	
			    	
			    	$scope.errorMsg="超时！请重试，并保证输入URL可以被正常访问！";
					$scope.inputFlag=true;
			    	$scope.$apply();//Angular的双向绑定在和第三方类库混用的时候有时会失效
		    	}
		    }
		});
		*/
	};
	
	$scope.progressHandlingJson =function(e){			
		var percent = e.loaded/e.total*100;
		console.log(percent);
		if(percent < 100){
			$scope.progress=percent.toFixed(2)+"%";
		}else{
			$scope.progress="转换中";
		}
		$scope.$apply();			
	}
		
	
});

function change(){
	var appElement = $('[ng-controller=activityCtrl]');
	var $scope = angular.element(appElement).scope();		
	$scope.jsonFile=$("#jsonFile")[0].files[0];	
	if($scope.jsonFile.size>5120000){
		$scope.errorMsg="文件超过5M,请重新选择文件上传。";
		$scope.inputFlag=true;
		$("#idGet").prop('disabled',true);			
	}else{
		$scope.inputFlag=false;
		$("#idGet").prop('disabled',false);
	}
	$scope.resultFlag=false;
	$scope.progress="提交";
	$scope.$apply();		
}



</script>
</html>